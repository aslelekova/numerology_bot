# handlers/user_input_handler.py

from aiogram import Router, types
from aiogram.filters.callback_data import CallbackData
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.filters.state import StateFilter

from calendar_module.calendar_utils import get_user_locale
from calendar_module.schemas import DialogCalendarCallback
from handlers.sections_handler import handle_section
from handlers.start_handler import cmd_start
from keyboards.sections_fate_matrix import create_sections_keyboard, create_reply_keyboard, functions_keyboard
from services.birthday_service import calculate_values
from services.calendar_service import process_calendar_selection, start_calendar
from services.gpt_service import EventHandler, generate_gpt_response
from services.message_service import delete_messages
from services.user_service import update_user_name, get_user_data, update_user_date
from states import Form

router = Router()


async def prompt_for_name(call: CallbackQuery, state: FSMContext, message_text: str, next_state: str):
    """
    Prompts the user to enter their name by sending a message and updating the state.

    :param call: The callback query object containing information about the callback event.
    :param state: The FSM (Finite State Machine) context to manage the state of the conversation.
    :param message_text: The text message to prompt the user for their name.
    :param next_state: The next state in the FSM after the user responds.
    :return: None
    """
    await call.message.delete()
    prompt_message = await call.message.answer(message_text)
    await state.update_data(prompt_message_id=prompt_message.message_id)
    await state.set_state(next_state)


@router.message(StateFilter(Form.waiting_for_name))
async def handle_params_input(message: types.Message, state: FSMContext):
    """
    Handles user input for their name, updates the state, and prompts the user to select a date of birth.

    :param message: The message object containing the user's input.
    :param state: The FSM (Finite State Machine) context to manage the state of the conversation.
    :return: None
    """
    user_name = message.text
    await update_user_name(state, user_name)

    data = await state.get_data()
    prompt_message_id = data.get("prompt_message_id")

    if prompt_message_id:
        try:
            await message.bot.delete_message(chat_id=message.chat.id, message_id=prompt_message_id)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    try:
        await message.delete()

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

    date_prompt_message = await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è üëá",
        reply_markup=await start_calendar(locale=await get_user_locale(message.from_user))
    )
    await state.update_data(date_prompt_message_id=date_prompt_message.message_id)
    await state.set_state(Form.waiting_for_data)

@router.callback_query(DialogCalendarCallback.filter())
async def process_selecting_category(callback_query: CallbackQuery, callback_data: CallbackData, state: FSMContext):
    selected, date = await process_calendar_selection(callback_query, callback_data)

    if selected:
        user_name, _ = await get_user_data(state)
        await update_user_date(state, date)

        day, month, year = date.day, date.month, date.year
        values = calculate_values(day, month, year)
        data = await state.get_data()
        previous_message_id = data.get("date_prompt_message_id")

        if previous_message_id:
            try:
                await callback_query.message.bot.delete_message(chat_id=callback_query.message.chat.id, message_id=previous_message_id)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º: {e}")

        generating_message = await callback_query.message.answer("‚è≥")

        response_text = None
        max_retries = 10
        attempt = 0
        response_text = "–õ–∏—á–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞:\n\n1. –•–∞—Ä–∞–∫—Ç–µ—Ä —á–µ–ª–æ–≤–µ–∫–∞: –≠–Ω–µ—Ä–≥–∏—è 4\n–ß–µ–ª–æ–≤–µ–∫ —Å —ç–Ω–µ—Ä–≥–∏–µ–π 4 –æ–±–ª–∞–¥–∞–µ—Ç —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–º –ª–∏–¥–µ—Ä—Å–∫–∏–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –∏ —É–º–µ–Ω–∏–µ–º –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ —ç—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–µ–ª–æ–≤–µ–∫—É —Å—Ç—Ä–æ–∏—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —É—Å–ø–µ—à–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∑–∞–Ω–∏–º–∞—è –≤—ã—Å–æ–∫–∏–µ —Ä—É–∫–æ–≤–æ–¥—è—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏. –ì–ª–∞–≤–Ω–æ–µ —É–º–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–µ–π 4 ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –¥–æ–≤–æ–¥–∏—Ç—å –Ω–∞—á–∞—Ç–æ–µ –¥–æ –∫–æ–Ω—Ü–∞. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏, –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è—é—Ç –¥–æ—Å—Ç–∏–≥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π. –õ–∏—á–Ω–æ—Å—Ç—å —Å —ç—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫ –ø–æ—Ä—è–¥–∫—É –∏ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏–π, –≤–∞–∂–Ω–æ —É–º–µ—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏ –∏ –∏–∑–±–µ–≥–∞—Ç—å –¥–µ—Å–ø–æ—Ç–∏–∑–º–∞.\n\n2. –ü–æ—Ä—Ç—Ä–µ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏: –≠–Ω–µ—Ä–≥–∏—è 18\n–≠–Ω–µ—Ä–≥–∏—è 18 –≤–µ–¥–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –∫ –ø–æ–∏—Å–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –≤ —ç–∑–æ—Ç–µ—Ä–∏–∫–µ –∏ –¥—É—Ö–æ–≤–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö. –û–±–ª–∞–¥–∞—Ç–µ–ª–∏ —ç—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –æ–±–ª–∞–¥–∞—é—Ç –º–æ—â–Ω–æ–π –∏–Ω—Ç—É–∏—Ü–∏–µ–π –∏ —Ç–∞–ª–∞–Ω—Ç–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Å–∏–ª—É –≤–æ –±–ª–∞–≥–æ, –º–æ–∂–Ω–æ –ø—Ä–∏–≤–ª–µ—á—å –∏–∑–æ–±–∏–ª–∏–µ –∏ —Å—á–∞—Å—Ç—å–µ. –û–¥–Ω–∞–∫–æ, –Ω—É–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤ –∏ –∏–ª–ª—é–∑–∏–π, –ø—Ä–∏–Ω–∏–º–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å —Ç–∞–∫–æ–π, –∫–∞–∫–∞—è –æ–Ω–∞ –µ—Å—Ç—å. –í–æ–¥–∞ –∏ –ª—É–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã –∏–≥—Ä–∞—é—Ç –≤–∞–∂–Ω—É—é —Ä–æ–ª—å –≤ –∂–∏–∑–Ω–∏ —Ç–∞–∫–∏—Ö –ª—é–¥–µ–π, –ø–æ–º–æ–≥–∞—è –∏–º –æ—á–∏—â–∞—Ç—å –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–∏—é.\n\n3. –í—ã—Å—à–∞—è —Å—É—Ç—å: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª ‚Äì –≠–Ω–µ—Ä–≥–∏—è 4, –¢–∞–ª–∞–Ω—Ç –æ—Ç –±–æ–≥–∞ ‚Äì –≠–Ω–µ—Ä–≥–∏—è 12, –ù–∞–≤—ã–∫ –ø—Ä–æ—à–ª–æ–≥–æ ‚Äì –≠–Ω–µ—Ä–≥–∏—è 8\n–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤ —ç–Ω–µ—Ä–≥–∏–∏ 4 –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç –ª–∏–¥–µ—Ä—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —É–º–µ–Ω–∏–µ –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã. –¢–∞–ª–∞–Ω—Ç –æ—Ç –ë–æ–≥–∞, —ç–Ω–µ—Ä–≥–∏—è 12, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞–π—Ç–∏ —Å–≤–æ–π –ø—É—Ç—å —Å–ª—É–∂–µ–Ω–∏—è –ª—é–¥—è–º, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–≤—ã—à–∞—è —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—è –¥–æ—Å—Ç–æ–π–Ω—É—é –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –∑–∞ —Å–≤–æ–∏ —É—Å–∏–ª–∏—è. –ù–∞–≤—ã–∫ –ø—Ä–æ—à–ª–æ–≥–æ, —ç–Ω–µ—Ä–≥–∏—è 8, —É—á–∏—Ç —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–Ω–∏–º–∞—Ç—å –∑–∞–∫–æ–Ω—ã –∫–∞—Ä–º—ã, –≤–∏–¥–µ—Ç—å –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ —Å–æ–±–ª—é–¥–∞—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ. –≠—Ç–∏ —ç–Ω–µ—Ä–≥–∏–∏ –≤ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ä–æ—Å—Ç —á–µ—Ä–µ–∑ –∑–Ω–∞–Ω–∏–µ, —Å–∏–ª—É –≤–æ–ª–∏ –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å.\n\n---\n\n2) –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ:\n\n1. –õ–∏—á–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —ç–Ω–µ—Ä–≥–∏—è 22\n–≠–Ω–µ—Ä–≥–∏—è 22 —Å–≤—è–∑–∞–Ω–∞ —Å –¥—É—Ö–æ–≤–Ω–æ–π —Å–≤–æ–±–æ–¥–æ–π –∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –õ–∏—á–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞ —Å —ç—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π —Å–æ—Å—Ç–æ–∏—Ç –≤ –ø–æ–∏—Å–∫–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ –±–µ–∑ –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏—è —á—É–∂–∏—Ö –º–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—É—Ç—å –∫ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—é –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≥–∞—Ä–º–æ–Ω–∏–∏, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤–∞–∂–Ω–æ –∏–∑–±–µ–≥–∞—Ç—å —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º–∞ –∏ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∫ –∂–∏–∑–Ω–∏.\n\n2. –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —ç–Ω–µ—Ä–≥–∏—è 8\n–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —á–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å. –ß–µ–ª–æ–≤–µ–∫ —Å 8 —ç–Ω–µ—Ä–≥–∏–µ–π –¥–æ–ª–∂–µ–Ω –∏–∑—É—á–∞—Ç—å –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–∫–æ–Ω—ã –∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å –∏–º, –ø—Ä–∏–Ω–∏–º–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –±–∞–ª–∞–Ω—Å, –∏–∑–±–µ–≥–∞—è –Ω–µ–Ω—É–∂–Ω—ã—Ö –±–∏—Ç–≤ –∑–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, —Ç–µ–º —Å–∞–º—ã–º —Å–æ–∑–¥–∞–≤–∞—è –º–∏—Ä –∏ –≥–∞—Ä–º–æ–Ω–∏—é –≤–æ–∫—Ä—É–≥ —Å–µ–±—è.\n\n3. –î—É—Ö–æ–≤–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —ç–Ω–µ—Ä–≥–∏—è 3\n–≠–Ω–µ—Ä–≥–∏—è 3 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –±—ã—Ç—å —Ç–≤–æ—Ä—Ü–æ–º —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –î—É—Ö–æ–≤–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–æ—Å—Ç–∞ –∏ –≥–∞—Ä–º–æ–Ω–∏–∏. –í–∞–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å —Å–≤–æ–∏–º –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º —Ä–µ—à–µ–Ω–∏—è–º –∏ –Ω–µ –±–æ—è—Ç—å—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ç–∞–ª–∞–Ω—Ç—ã –≤–æ –≤–Ω–µ—à–Ω–µ–º –º–∏—Ä–µ.\n\n4. –ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —ç–Ω–µ—Ä–≥–∏—è 11\n–≠–Ω–µ—Ä–≥–∏—è 11 —Å–≤—è–∑–∞–Ω–∞ —Å —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–∏–ª—ã –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞. –ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ –∞–≥—Ä–µ—Å—Å–∏–µ–π –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∏–ª—ã –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ–∑–∏–¥–∞–Ω–∏—è. –í–∞–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º –º–∏—Ä–æ–º —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ, —Å–æ–∑–¥–∞–≤–∞—è –≤–æ–∫—Ä—É–≥ —Å–µ–±—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω—É—é —Å—Ä–µ–¥—É –∏ –ø—Ä–∏–≤–Ω–æ—Å–∏—Ç—å –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—É—é –∂–∏–∑–Ω—å —Å–æ–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –∏ –≥–∞—Ä–º–æ–Ω–∏—é.\n\n---\n\n3) –î–µ—Ç—Å–∫–æ-—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:\n\n1. –î–ª—è —á–µ–≥–æ –¥—É—à–∞ –ø—Ä–∏—à–ª–∞ –∫ —Ä–æ–¥–∏—Ç–µ–ª—è–º: —ç–Ω–µ—Ä–≥–∏—è 18\n–≠–Ω–µ—Ä–≥–∏—è 18 –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫—É —Å–≤–æ–∏—Ö —Å—Ç—Ä–∞—Ö–æ–≤ –∏ –∏–ª–ª—é–∑–∏–π. –û–Ω–∞ –ø–æ–¥—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∏ –¥—É—Ö–æ–≤–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –±—ã—Ç–∏—è, —á—Ç–æ, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º—É —Ä–æ—Å—Ç—É. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –æ–±—Ä–µ—Ç–µ–Ω–∏—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å—Ç–µ—Ä–∂–Ω—è —á–µ—Ä–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≥–ª—É–±–æ–∫–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.\n\n2. –ó–∞–¥–∞—á–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π: —ç–Ω–µ—Ä–≥–∏—è 4\n–≠–Ω–µ—Ä–≥–∏—è 4 –ø—Ä–µ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª–∏–¥–µ—Ä—Å—Ç–≤–∞. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ —Ç—Ä–µ–±—É–µ—Ç —É–º–µ–Ω–∏—è –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –ø–æ—Å—Ç—É–ø–∫–∏. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —Å–µ–º–µ–π–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –ø–æ—Ä—è–¥–∫–∞ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n\n3. –û—à–∏–±–∫–∏ –≤–æ –≤–∑–∞–∏–º–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ –∏ —Å–≤–æ–∏–º–∏ –¥–µ—Ç—å–º–∏: —ç–Ω–µ—Ä–≥–∏—è 22\n–≠–Ω–µ—Ä–≥–∏—è 22 –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞–∂–Ω–æ—Å—Ç—å –∏–∑–±–µ–≥–∞–Ω–∏—è –¥–µ—Å–ø–æ—Ç–∏–∑–º–∞ –∏ –∏–∑–ª–∏—à–Ω–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è. –û—à–∏–±–∫–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç, –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–≤—è–∑—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –º–Ω–µ–Ω–∏—è –∏ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º —Å–≤–æ–±–æ–¥–Ω–æ –≤—ã—Ä–∞–∂–∞—Ç—å —Å–µ–±—è. –í–∞–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —É–≤–∞–∂–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞.\n\n---\n\n4) –¢–∞–ª–∞–Ω—Ç—ã:\n\n1. –¢–∞–ª–∞–Ω—Ç –æ—Ç –±–æ–≥–∞: —ç–Ω–µ—Ä–≥–∏—è 12\n–≠–Ω–µ—Ä–≥–∏—è 12 —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç–∏—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —á–µ—Ä–µ–∑ —Å–ª—É–∂–µ–Ω–∏–µ –∏ –ø–æ–º–æ—â—å –¥—Ä—É–≥–∏–º. –¢–∞–ª–∞–Ω—Ç —ç—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –æ–∫—Ä—É–∂–∞—é—â–∏—Ö, –Ω–∞—Ö–æ–¥—è –ø—É—Ç–∏ —Å–ª—É–∂–µ–Ω–∏—è –∏ –ª–∏—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–æ–≥–æ –¥–∞—Ä–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Å–ø–µ—Ö—É –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ, –Ω–æ –∏ –≤ –º–µ–∂–ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –≤–∑–∞–∏–º–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n\n2. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª: —ç–Ω–µ—Ä–≥–∏—è 4\n–≠–Ω–µ—Ä–≥–∏—è 4 –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–∏–¥–µ—Ä—Å–∫–∏—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–∏ –∫ –ø–æ—Ä—è–¥–∫—É –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–∞–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤–µ—Å—Ç–∏ –∑–∞ —Å–æ–±–æ–π –∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –≠—Ç–æ —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏—è, –≤ —Ä–∞–º–∫–∞—Ö –∫–æ—Ç–æ—Ä–æ–π –≤–∞–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ–º –∏ —Å—Ç–∞—Ä–∞—Ç—å—Å—è –∏–∑–±–µ–≥–∞—Ç—å –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏.\n\n3. –ù–∞–≤—ã–∫ –ø—Ä–æ—à–ª–æ–≥–æ: —ç–Ω–µ—Ä–≥–∏—è 8\n–≠–Ω–µ—Ä–≥–∏—è 8 –≤—ã–≤–æ–¥–∏—Ç —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –ø—É—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç–∏ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–∫–æ–Ω–æ–≤. –ù–∞–≤—ã–∫ –ø—Ä–æ—à–ª–æ–≥–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å —á–µ—Å—Ç–Ω—ã–µ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –æ–ø—ã—Ç –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å. –≠—Ç–æ —ç–Ω–µ—Ä–≥–∏—è, –¥–∞—é—â–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –±—É–¥—É—â–µ–≥–æ.')"
        # response_text = await generate_gpt_response(user_name, values)
        # while response_text is None and attempt < max_retries:
        #     attempt += 1
        #     response_text = await generate_gpt_response(user_name, values)
        #     if not response_text:
        #         print(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.")

        await state.update_data(response_text=response_text)

        await generating_message.delete()

        if not response_text:
            await callback_query.message.answer(
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.",
            )
            await cmd_start(callback_query.message, state)
            return

        response_text = response_text.replace("#", "").replace("*", "")

        split_text = response_text.split("---")
        categories = [
            "–õ–∏—á–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞",
            "–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ",
            "–î–µ—Ç—Å–∫–æ-—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
            "–¢–∞–ª–∞–Ω—Ç—ã",
            "–†–æ–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
            "–ö–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Ö–≤–æ—Å—Ç",
            "–ì–ª–∞–≤–Ω—ã–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π —É—Ä–æ–∫",
            "–û—Ç–Ω–æ—à–µ–Ω–∏—è",
            "–î–µ–Ω—å–≥–∏"
        ]

        categories_dict = {category: split_text[i].strip() for i, category in enumerate(categories) if i < len(split_text)}

        await state.update_data(full_response=categories_dict)

        sections_keyboard = create_sections_keyboard()
        first_message = await callback_query.message.answer(
            "–£—Ä–∞, –≤–∞—à–∞ –º–∞—Ç—Ä–∏—Ü–∞ —Å—É–¥—å–±—ã –≥–æ—Ç–æ–≤–∞ üîÆ\n\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–∫–ª–∞–¥ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤.\n"
            "‚úÖ - –¥–æ—Å—Ç—É–ø–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ\n"
            "üîê - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø",
            reply_markup=sections_keyboard
        )
        await state.update_data(first_message_id=first_message.message_id)

        three_functions = functions_keyboard()
        question_prompt_message = await callback_query.message.answer(
            f"–ü–æ–ª—É—á–∏—Ç–µ <b>–æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã</b> —Å –ü–û–õ–ù–´–ú –¥–æ—Å—Ç—É–ø–æ–º –∫:\nüîÆ –ú–∞—Ç—Ä–∏—Ü–µ —Å—É–¥—å–±—ã\nüí∏ –ù—É–º–µ—Ä–æ–ª–æ–≥–∏–∏"
            " | –õ–∏—á–Ω–æ–º—É —É—Å–ø–µ—Ö—É | –§–∏–Ω–∞–Ω—Å–∞–º\nüíï –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º\n\n–ò–ª–∏ <b>–∑–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å</b> –Ω–∞—à–µ–º—É "
            "–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º—É –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –∏ –ø–æ–ª—É—á–∏—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: üíï<b>–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º?</b>)",
            reply_markup=three_functions,
            parse_mode="HTML"
        )

        await state.update_data(question_prompt_message_id=question_prompt_message.message_id)


@router.callback_query(lambda callback: callback.data.startswith("section_"))
async def handle_section_callback(callback_query: CallbackQuery, state: FSMContext):
    free_categories = {
        "section_personal": "–õ–∏—á–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞",
        "section_destiny": "–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ",
        "section_talents": "–¢–∞–ª–∞–Ω—Ç—ã",
        "section_family_relationships": "–î–µ—Ç—Å–∫–æ-—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
    }

    category_mapping = {
        "section_personal": "–õ–∏—á–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞",
        "section_destiny": "–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ",
        "section_talents": "–¢–∞–ª–∞–Ω—Ç—ã",
        "section_family_relationships": "–î–µ—Ç—Å–∫–æ-—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
        "section_generic_programs": "–†–æ–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã",
        "section_karmic_tail": "–ö–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Ö–≤–æ—Å—Ç",
        "section_karmic_lesson": "–ì–ª–∞–≤–Ω—ã–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π —É—Ä–æ–∫",
        "section_relationships": "–û—Ç–Ω–æ—à–µ–Ω–∏—è",
        "section_money": "–î–µ–Ω—å–≥–∏",
    }

    category = category_mapping.get(callback_query.data, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è")

    data = await state.get_data()
    first_message_id = data.get("first_message_id")
    question_prompt_message_id = data.get("question_prompt_message_id")

    if callback_query.data not in free_categories:
        data = await state.get_data()
        previous_warning_message_id = data.get("previous_warning_message_id")
        if previous_warning_message_id:
            try:
                await callback_query.bot.delete_message(
                    chat_id=callback_query.message.chat.id,
                    message_id=previous_warning_message_id
                )
            except Exception as e:
                if "message to delete not found" not in str(e):
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–ª–∞—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {e}")

        warning_message = await callback_query.message.answer(
            "–≠—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø."
        )
        await state.update_data(previous_warning_message_id=warning_message.message_id)
        return

    await delete_messages(callback_query.bot, callback_query.message.chat.id, [first_message_id, question_prompt_message_id])
    await handle_section(callback_query, state, category)
